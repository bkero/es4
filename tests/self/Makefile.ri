# Drivers for ESC running on the ES4 reference implementation

WINROOT=/src/adobe_flashfarm/main
ROOT=/cygdrive/c/$(WINROOT)
ASC=asc
ASCFLAGS=-d -import $(WINROOT)/player/FlashPlayer/avmglue/global.abc -import $(WINROOT)/player/FlashPlayer/avmglue/playerglobal.abc
AVM=$(ROOT)/player/FlashPlayer/avmplus/platform/win32/obj_8/shell/Debug_Debugger/avmplus_sd.exe

.SUFFIXES: .abc .es

.es.abc:
	$(ASC) $(ASCFLAGS) $<

test_cogen:
	rm -f hello-test.es
	echo '{ import cogen.*; intrinsic::load("tests/self/esc-ri.es"); cogen.testHelloWorld(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../hello-test.es .
	$(MAKE) hello-test.abc
	$(AVM) hello-test.abc

test: test_hello test_fib test_loop test_switch1 test_switch2

# Clumsy, slow, but works
#
# Each .es file generated by the running of the RI is a simple wrapper 
# program plus an array of byte values representing the already-compiled
# program.  The use of ASC is not strictly necessary; we could have
# dumped byte values from the RI, or used an external utility to create
# ascii byte values to real bytes, or had a precompiled AS3 loader script
# to read the byte values into the AVM.

test_hello: esc-ri.es
	rm -f hello-test.es
	echo '{ import assembler.*; intrinsic::load("tests/self/esc-ri.es"); assembler.testHelloWorld(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../hello-test.es .
	$(MAKE) hello-test.abc
	$(AVM) hello-test.abc

test_fib: esc-ri.es
	rm -f fib-test.es
	echo '{ import assembler.*; intrinsic::load("tests/self/esc-ri.es"); assembler.testFib(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../fib-test.es .
	$(MAKE) fib-test.abc
	$(AVM) fib-test.abc

test_loop: esc-ri.es
	rm -f loop-test.es
	echo '{ import assembler.*; intrinsic::load("tests/self/esc-ri.es"); assembler.testLoop(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../loop-test.es .
	$(MAKE) loop-test.abc
	$(AVM) loop-test.abc

test_switch1: esc-ri.es
	rm -f switch1-test.es
	echo '{ import assembler.*; intrinsic::load("tests/self/esc-ri.es"); assembler.testSwitch1(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../switch1-test.es .
	$(MAKE) switch1-test.abc
	$(AVM) switch1-test.abc

test_switch2: esc-ri.es
	rm -f switch2-test.es
	echo '{ import assembler.*; intrinsic::load("tests/self/esc-ri.es"); assembler.testSwitch2(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../switch2-test.es .
	$(MAKE) switch2-test.abc
	$(AVM) switch2-test.abc

test_let: esc-ri.es
	rm -f let-test.es
	echo '{ import assembler.*; intrinsic::load("tests/self/esc-ri.es"); assembler.testLet(); }' | ( cd ../.. ; make; sml @SMLload=es4-init.heap -r ) 
	mv ../../let-test.es .
	$(MAKE) let-test.abc
	$(AVM) let-test.abc


# Poor man's "include" facility

esc-ri.es: util-es4ri.es util.es bytestream.es bytestream_test.es abcfile.es abcfile_test.es assembler.es assembler_test.es # emitter.es cogen-expr.es cogen-stmt.es cogen.es cogen_test.es
	cat $^ > esc-ri.es

clean:
	rm -f *~ *.abc hello-test.es fib-test.es esc-ri.es
